# Technical Details

## Windows API Functions

### Thread Management
- `CreateThread()` – Creates a new thread within the current process
- `SleepEx()` – Puts a thread into a wait state
- `WaitForSingleObject()` – Synchronizes execution and keeps process alive
- `CloseHandle()` – Releases thread handles

---

### APC Mechanism
- `QueueUserAPC()` – Queues an Asynchronous Procedure Call to a specific thread
- `PAPCFUNC` – Function pointer type required for APC callbacks

**Key Requirement:**  
The target thread **must be in an alertable state** for the APC to execute.

---

### User Interaction
- `MessageBoxW()` – Displays a message box to confirm successful APC execution

---

## Execution Primitives

### Alertable State
```c
SleepEx(INFINITE, TRUE);
```
- TRUE enables alertable mode
- Allows queued APCs to be executed
- Without this, APC delivery will not occur

---


## Function Signature Requirements

### APC Callback
```c
VOID CALLBACK ApcPayload(ULONG_PTR dwParam);
```

### Requirements

- Must return `VOID`
- Must accept a single `ULONG_PTR` argument
- Must follow the `CALLBACK` calling convention

---

## Data Flow

- Main thread creates a secondary thread
- Secondary thread enters alertable sleep
- Main thread queues APC
- Windows dispatches APC
- Payload function executes

---

## Safety Implementation

### No Executable Memory
- No use of `VirtualAlloc` or `VirtualProtect`
- No `PAGE_EXECUTE_*` permissions
- No dynamic code execution
- No shellcode

### Payload Characteristics
- Payload is a normal C function
- Compiled as part of the binary
- Executed via legitimate control flow

### No Remote Injection
- APC is queued to a local thread
- No `OpenProcess`
- No cross-process memory operations

---

## Benign Payload

```c
MessageBoxW(
    NULL,
    L"APC Injection Executed Successfully",
    L"APC Demo",
    MB_OK | MB_ICONINFORMATION
);
```
### Characteristics:
- Provides visible execution proof
- No system modification
- No persistence or side effects

---

## Proper Cleanup:
- Thread handles are closed
- No leaked resources
- Process exits cleanly after execution
