rule Registry_Persistence_Technique {
    meta:
        author = "NIZAR ADERBAZ"
        description = "Detects registry persistence technique using custom registry keys for data storage"
        date = "2025"
        reference = "Internal Research"
        severity = "High"
    
    strings:
        $reg_create = "RegCreateKeyExA" wide ascii
        $reg_set = "RegSetValueExA" wide ascii
        $reg_open = "RegOpenKeyExA" wide ascii
        $reg_query = "RegQueryValueExA" wide ascii
        $heap_alloc = "HeapAlloc" wide ascii
        $heap_free = "HeapFree" wide ascii
        $software_key = "Software\\\\MySafeDemo" wide ascii
        $nizar_value = "nizar" wide ascii
        $reg_binary = "REG_BINARY" wide ascii
        
    condition:
        (filesize < 50KB) and 
        (uint16(0) == 0x5A4D) and  // PE file signature
        (
            (4 of ($reg_create, $reg_set, $reg_open, $reg_query, $heap_alloc, $heap_free)) or
            (all of ($reg_create, $reg_set) and any of ($software_key, $nizar_value))
        )
}
