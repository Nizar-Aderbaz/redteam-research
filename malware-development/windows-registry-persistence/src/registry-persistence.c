#include <Windows.h>
#include <stdio.h>

BOOL WriteShellInReg(PBYTE pShellcode, DWORD sShellcode) {
	HKEY handleKey = NULL;
	LONG res = RegCreateKeyExA(HKEY_CURRENT_USER, "Software\\MySafeDemo", 0, NULL, 0, KEY_WRITE, NULL, &handleKey, NULL);
	if (res != ERROR_SUCCESS) {
		printf("[!] RegCreateKeyExA failed: %ld\n", res);
		return FALSE;
	}

	res = RegSetValueExA(handleKey, "nizar", 0, REG_BINARY, pShellcode, sShellcode);
	if (res != ERROR_SUCCESS) {
		printf("[!] RegSetValueExA failed: %ld\n", res);
		RegCloseKey(handleKey);
		return FALSE;
	}

	RegCloseKey(handleKey);
	return TRUE;
}

BOOL ReadShellInReg(PBYTE* RShellcode, DWORD* RsShellcode) {
	HKEY handleKey = NULL;
	LONG res = RegOpenKeyExA(HKEY_CURRENT_USER, "Software\\MySafeDemo", 0, KEY_READ, &handleKey);
	if (res != ERROR_SUCCESS) {
		printf("[!] RegOpenKeyExA failed: %ld\n", res);
		return FALSE;
	}

	DWORD type = 0;
	DWORD dwBytesReads = 0;
	// Query size
	res = RegQueryValueExA(handleKey, "nizar", NULL, &type, NULL, &dwBytesReads);
	if (res != ERROR_SUCCESS || type != REG_BINARY) {
		printf("[!] RegQueryValueExA (size) failed or unexpected type: %ld (type=%u)\n", res, type);
		RegCloseKey(handleKey);
		return FALSE;
	}

	PVOID pBytes = HeapAlloc(GetProcessHeap(), 0, dwBytesReads);
	if (!pBytes) {
		printf("[!] HeapAlloc failed\n");
		RegCloseKey(handleKey);
		return FALSE;
	}

	res = RegQueryValueExA(handleKey, "nizar", NULL, NULL, pBytes, &dwBytesReads);
	if (res != ERROR_SUCCESS) {
		printf("[!] RegQueryValueExA (read) failed: %ld\n", res);
		HeapFree(GetProcessHeap(), 0, pBytes);
		RegCloseKey(handleKey);
		return FALSE;
	}

	RegCloseKey(handleKey);

	*RShellcode = (PBYTE)pBytes;
	*RsShellcode = dwBytesReads;
	return TRUE;
}

BOOL RunShellInReg_SafePrint(PBYTE ppShellcode, SIZE_T dwwShellcode) {
	printf("Safe print of %zu bytes (hex):\n", dwwShellcode);
	for (SIZE_T i = 0; i < dwwShellcode; ++i) {
		printf("%02X ", ppShellcode[i]);
	}
	printf("\n");
	if (dwwShellcode > 0 && ppShellcode[dwwShellcode - 1] == 0) {
		printf("As string: %s\n", (char*)ppShellcode);
	}
	return TRUE;
}

unsigned char shellcode[] = { 0x63,0x61,0x6c,0x63,0x2e,0x65,0x78,0x65,0x00 }; // "calc.exe\0"

int main() {
	PBYTE TheShellcode = NULL;
	DWORD TheSizeOfShellcode = 0;

	if (!WriteShellInReg(shellcode, sizeof(shellcode))) {
		printf("WriteShellInReg failed\n");
		return 1;
	}

	if (!ReadShellInReg(&TheShellcode, &TheSizeOfShellcode)) {
		printf("ReadShellInReg failed\n");
		return 1;
	}

	RunShellInReg_SafePrint(TheShellcode, TheSizeOfShellcode);

	HeapFree(GetProcessHeap(), 0, TheShellcode);
	getchar();
	return 0;
}
