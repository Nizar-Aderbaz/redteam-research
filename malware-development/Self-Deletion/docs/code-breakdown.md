# Code Breakdown - Simple Explanation

## What This Code Does
This program demonstrates how a Windows executable can delete itself from the hard drive while it's still running.

## The Key Idea
Normally, Windows prevents you from deleting a file that's currently in use. This technique uses a clever trick:
1. **Rename the file's data** to a "hidden" location (called an alternate stream)
2. **Delete that hidden data** instead of the main file
3. The result: the file disappears even though the program is still running

## Main Components

### 1. SelfDelete() Function - The "Magic" Part
```c
BOOL SelfDelete()
```
**Purpose:**
Handles the complete self-deletion process from finding the file to removing it

**How:**
- Gets the current executable's file path
- Renames the file's main data to an alternate stream
- Deletes the alternate stream
- Uses fallback methods if the main technique fails

**Returns:**
TRUE if successful, FALSE if deletion fails

---

### 2. Getting Current File Location
```c
GetModuleFileNameW(NULL, szPath, MAX_PATH * 2)
```

**Purpose:**
Finds where the running program is located on disk

**How:**
Asks Windows for the full path of the current executable

**Result:**
Stores the path in szPath (e.g., "C:\Users\Test\program.exe")

---

### 3. Preparing Stream Rename
```c
pRename = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sRename);
```

**Purpose:**
Creates instructions for renaming the file's data stream

**How:**
Allocates memory for a FILE_RENAME_INFO structure that tells Windows to rename :$DATA (main stream) to :NEWDATA (alternate stream)

---

### 4. Opening Special File Handle
```c
hFile = CreateFileW(szPath, DELETE | SYNCHRONIZE | FILE_WRITE_ATTRIBUTES, ...)
```

**Purpose:**
Opens a special handle to the executable with delete permissions

**Key Flags:**
- DELETE : Permission to delete the file
- FILE_FLAG_OPEN_REPARSE_POINT : Allows working with alternate data streams
- FILE_SHARE_DELETE : Allows other processes to delete the file

---

### 5. Renaming Data Stream
```c
SetFileInformationByHandle(hFile, FileRenameInfo, pRename, sRename)
```

**Purpose:**
Moves the main file data to an alternate stream

**What happens:**
Renames program.exe:$DATA → program.exe:NEWDATA
(File still exists, but its main content is now in a hidden location)

---

### 6. Deleting Alternate Stream
```c
SetFileInformationByHandle(hFile, FileDispositionInfo, &Delete, sizeof(Delete))
```

**Purpose:**
Deletes the renamed data stream

**How:**
Marks the :NEWDATA stream for deletion with Delete.DeleteFile = TRUE
File is actually removed when the handle closes

---

### 7. Main Program Entry
```c
int main()
```

- **Step 1:** Calls SelfDelete() to remove the executable
- **Step 2:** Reports success or failure
- **Step 3:** Program continues running even though its file is gone

---

##  Key Safety Features

- ✅ Multiple fallback methods — if rename fails, tries direct deletion
- ✅ Complete error checking — every Windows API call is verified
- ✅ Proper cleanup — all handles and memory are released
- ✅ Informative output — shows each step of the process
- ✅ Graceful failure — doesn't crash if deletion fails

---
