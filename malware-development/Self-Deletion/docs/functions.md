# Functions Explanation

## SelfDelete()
**Purpose**: Deletes the running executable from disk using NTFS alternate data streams

**Key Operations:**
- `GetModuleFileNameW()` - Gets the current executable's file path
- `CreateFileW()` - Opens handle to self with DELETE permissions
- `SetFileInformationByHandle()` with `FileRenameInfo` - Renames data stream
- `SetFileInformationByHandle()` with `FileDispositionInfo` - Marks for deletion
- `HeapAlloc()/HeapFree()` - Manages memory for rename structure

**Parameters:** None (operates on the current executable)

**Returns:**
- `TRUE` - Successfully deleted itself
- `FALSE` - Deletion failed

**Process Flow:**
1. Get own executable path
2. Prepare rename structure for alternate data stream
3. Open handle with DELETE permissions
4. Rename :$DATA stream to :NEWDATA stream
5. Delete the :NEWDATA stream
6. Clean up handles and memory

---

## GetModuleFileNameW()
**Purpose**: Retrieves the full path of the running executable

**Key Parameters:**
- `NULL` - Current module (self)
- `szPath` - Buffer to store the path
- `MAX_PATH * 2` - Buffer size

**Usage:**
```c
GetModuleFileNameW(NULL, szPath, MAX_PATH * 2)
```

---

## CreateFileW() (Special Flags Version)
**Purpose:** Opens a handle to the executable with stream manipulation permissions

**Key Flags Used:**
- DELETE: Permission to delete the file
- SYNCHRONIZE: Allows synchronous operations
- FILE_WRITE_ATTRIBUTES: Can modify file attributes
- FILE_FLAG_OPEN_REPARSE_POINT: Enables alternate data stream access
- FILE_FLAG_BACKUP_SEMANTICS: Required for stream operations
- FILE_SHARE_DELETE: Allows other processes to delete the file

**Usage:**
Creates a "backdoor" handle that can rename and delete the file's streams

---

## SetFileInformationByHandle()
**Purpose:** Performs file operations through a handle

1. File Rename (Stream Manipulation):
```c
SetFileInformationByHandle(hFile, FileRenameInfo, pRename, sRename)
```
- Renames the file's data stream
- Changes :$DATA â†’ :NEWDATA
- Uses FILE_RENAME_INFO structure

2. File Deletion:
```c
SetFileInformationByHandle(hFile, FileDispositionInfo, &Delete, sizeof(Delete))
```
- Marks file/stream for deletion
- Uses FILE_DISPOSITION_INFO structure
- DeleteFile = TRUE triggers deletion on handle close

---

## Windows API Used
**File Path Operations:** 
- GetModuleFileNameW() - Gets executable location

**File Handle Operations:** 
- CreateFileW() - Opens file with special permissions
- CloseHandle() - Closes file handles

**File Manipulation:**
- SetFileInformationByHandle() - Renames and deletes files/streams

**Memory Management:**
- HeapAlloc() - Allocates rename structure memory
- HeapFree() - Frees allocated memory

**Error Handling:**
- GetLastError() - Retrieves Windows error codes
- Various printf functions for error reporting

---

## Important Structures
**FILE_RENAME_INFO:**
```c
typedef struct _FILE_RENAME_INFO {
    BOOLEAN ReplaceIfExists;  // Replace if stream exists
    HANDLE  RootDirectory;    // Root directory (NULL for current)
    DWORD   FileNameLength;   // Length of new name
    WCHAR   FileName[1];      // New stream name (":NEWDATA")
} FILE_RENAME_INFO;
```

**FILE_DISPOSITION_INFO**
```c
typedef struct _FILE_DISPOSITION_INFO {
    BOOLEAN DeleteFile;  // TRUE = delete when handle closes
} FILE_DISPOSITION_INFO;
```

**Key Points:**
- Both structures used with SetFileInformationByHandle()
- Memory for FILE_RENAME_INFO must include space for filename
- DeleteFile = TRUE doesn't delete immediately, only on handle close

