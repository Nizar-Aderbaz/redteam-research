# Technical Details

## Windows API Functions

### File Path & Information
- `GetModuleFileNameW()` - Retrieves full path of running executable
- Returns length of string or 0 on failure
- Uses `NULL` as first parameter for current process module

### File Handle Operations
- `CreateFileW()` - Opens handle with specific access rights
- `CloseHandle()` - Properly closes file handles to trigger cleanup

### File Manipulation
- `SetFileInformationByHandle()` - Performs file operations through handles
  - `FileRenameInfo` - Renames files or alternate data streams
  - `FileDispositionInfo` - Marks files for deletion on handle close

### Memory Management
- `HeapAlloc()` - Allocates memory from process heap
- `HeapFree()` - Releases allocated heap memory
- `HEAP_ZERO_MEMORY` - Flag to zero-initialize allocated memory

## Key Parameters and Flags

### CreateFileW Access Rights
- `DELETE` - Permission to delete the file/stream
- `SYNCHRONIZE` - Enables synchronous operations
- `FILE_WRITE_ATTRIBUTES` - Permission to modify file attributes

### CreateFileW Share Mode
- `FILE_SHARE_READ` - Others can read the file
- `FILE_SHARE_WRITE` - Others can write to the file
- `FILE_SHARE_DELETE` - Others can delete the file (crucial for self-deletion)

### CreateFileW Flags
- `FILE_FLAG_OPEN_REPARSE_POINT` - Enables alternate data stream access
- `FILE_FLAG_BACKUP_SEMANTICS` - Required for stream operations
- `OPEN_EXISTING` - Opens existing file only (won't create new)

### SetFileInformationByHandle Info Classes
- `FileRenameInfo` (value: 2) - Used for renaming operations
- `FileDispositionInfo` (value: 4) - Used for deletion marking

## NTFS Alternate Data Streams

### Stream Syntax
- `filename:streamname:streamtype`
- `program.exe` → Main file
- `program.exe:$DATA` → Default data stream (the actual executable)
- `program.exe:NEWDATA` → Alternate data stream (created by this technique)

### Stream Types
- `:$DATA` - Default data stream (contains file content)
- `:$INDEX_ALLOCATION` - Directory stream
- `:$ATTRIBUTE_LIST` - Attribute list
- Custom streams (like `:NEWDATA`) can be created

## Memory Allocation Strategy

### Buffer Size Calculation
```c
SIZE_T StreamLength = wcslen(NewStream) * sizeof(wchar_t);
SIZE_T sRename = sizeof(FILE_RENAME_INFO) + StreamLength;
```
- Accounts for WCHAR size (2 bytes per character)
- Includes flexible array member space in structure

### Heap Allocation
```c
pRename = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sRename);
```
- Uses process heap instead of C runtime heap
- HEAP_ZERO_MEMORY ensures structure is zero-initialized

## Error Handling Strategy

### Common Error Codes
- ERROR_ACCESS_DENIED (5) - Insufficient permissions
- ERROR_SHARING_VIOLATION (32) - File locked by another process
- ERROR_FILE_NOT_FOUND (2) - File already deleted or doesn't exist

### Fallback Mechanism
1. Primary method: Rename stream then delete
2. Secondary method: Direct deletion if rename fails
3. Graceful failure: Returns FALSE with error information

### Safe Operations
- Only operates on current process's executable
- No elevation of privileges attempted
- No modification of other files or system areas
